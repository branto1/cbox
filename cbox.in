#!/bin/bash

set -e

# cbox hooks dir
[ -z "$cboxhooksdir" ] && cboxhooksdir="HOOKSDIR"

function print_usage() {
	echo "$(basename $0) usage:"
	echo ""
}

function is_integer() {
    [ "$1" -eq "$1" ] > /dev/null 2>&1
    return $?
}

# parse command line options
#
# c -> cluster name (cboxclustername)
# h -> help
# n -> number of nodes (cboxnumnodes)
# t -> type (cboxclustertype)
# v -> verbose

# clear envvars
cboxclustername=""
cboxnumnodes=""
cboxclustertype=""
cboxverbose=""

while getopts ":c:hn:t:v" optflag; do
	case "$optflag" in
	c)
		cboxclustername="$OPTARG"
		;;
	n)
		cboxnumnodes="$OPTARG"
		! is_integer $numnodes && {
			echo "ERROR: number of nodes needs to be an integer (min 2, max 16)"
			exit 1
		}
		if [ "$cboxnumnodes" -lt "2" ] || \
		   [ "$cboxnumnodes" -gt "16" ]; then
			echo "ERROR: invalid number of nodes specified (min 2, max 16)"
			exit 1
		fi
		;;
	t)
		cboxclustertype="$OPTARG"
		if [ "$cboxclustertype" != "cman" ] && \
		   [ "$cboxclustertype" != "pacemaker" ]; then
			echo "ERROR: cluster type has to be cman or pacemaker"
			exit 1
		fi
		;;
	v)
		cboxverbose="yes"
		;;
	h)
		print_usage
		exit 0
		;;
	\?|:)
		print_usage
		exit 1
		;;
	esac
done

[ -z "$cboxclustername" ] && {
	echo "ERROR: please specify the clustername"
	print_usage
	exit 1
}

[ -z "$cboxnumnodes" ] && {
	echo "INFO: no number of nodes specified, default to 2"
	cboxnumnodes=2
}

[ -z "$cboxclustertype" ] && {
	echo "INFO: no cluster type defined, default to cman"
	cboxclustertype=cman
}

export cboxhooksdir
export cboxclustername
export cboxnumnodes
export cboxclustertype
export cboxverbose

exit 0
