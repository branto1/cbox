#!/bin/bash

set -e

[ "$(whoami)" != "root" ] && {
	echo "Need root baby"
	exit 1
}

# cbox data dir
[ -z "$cboxdatadir" ] && cboxdatadir="DATADIR"

# cbox hooks dir
[ -z "$cboxhooksdir" ] && cboxhooksdir="$cboxdatadir/hooks"

# basic logging
[ -z "$cboxlogdir" ] && cboxlogdir="LOGDIR"
cboxlogfile=$cboxlogdir/cbox-$(date +%F_%T).log

function print_usage() {
	echo "$(basename $0) usage:"
	echo ""
}

function is_integer() {
    [ "$1" -eq "$1" ] > /dev/null 2>&1
    return $?
}

# parse command line options
#
# c -> cluster name (cboxclustername)
# h -> help
# m -> resource manager (cboxrasmngr) rgmanager|pacemaker|none
# n -> number of nodes (cboxnumnodes)
# r -> fedora release (13 / 14 / rawhide)
# t -> type (cboxclustertype) cman|corosync
# v -> verbose

# clear envvars (when adding, make sure to export them below)
cboxclustername=""
cboxnumnodes=""
cboxclustertype=""
cboxverbose=""
cboxfedrelease=""
cboxrasmngr=""

while getopts ":c:hm:n:r:t:v" optflag; do
	case "$optflag" in
	c)
		cboxclustername="$OPTARG"
		;;
	m)
		cboxrasmngr="$OPTARG"
		if [ "$cboxrasmngr" != "rgmanager" ] && \
		   [ "$cboxrasmngr" != "pacemaker" ] && \
		   [ "$cboxrasmngr" != "none" ]; then
			echo "ERROR: cluster resource manager has to be rgmanager, pacemaker or none"
			exit 1
		fi
		;;
	n)
		cboxnumnodes="$OPTARG"
		! is_integer $cboxnumnodes && {
			echo "ERROR: number of nodes needs to be an integer (min 2, max 16)"
			exit 1
		}
		if [ "$cboxnumnodes" -lt "2" ] || \
		   [ "$cboxnumnodes" -gt "16" ]; then
			echo "ERROR: invalid number of nodes specified (min 2, max 16)"
			exit 1
		fi
		;;
	r)
		cboxfedrelease="$OPTARG"
		;;
	t)
		cboxclustertype="$OPTARG"
		if [ "$cboxclustertype" != "cman" ] && \
		   [ "$cboxclustertype" != "corosync" ]; then
			echo "ERROR: cluster type has to be cman or corosync"
			exit 1
		fi
		;;
	v)
		cboxverbose="yes"
		;;
	h)
		print_usage
		exit 0
		;;
	\?|:)
		print_usage
		exit 1
		;;
	esac
done

[ ! -d "$cboxdatadir" ] && {
	echo "ERROR: no valid data directory specified: $cboxdatadir"
	exit 1
}

[ ! -d "$cboxhooksdir" ] && {
	echo "ERROR: no valid hooks directory specified: $cboxhooksdir"
	exit 1
}

[ ! -d "$cboxlogdir" ] && {
	echo "ERROR: no valid log directory specified: $cboxlogdir"
	exit 1
}

touch $cboxlogfile || {
	echo "ERROR: unable to write to logfile: $cboxlogfile"
	exit 1
}

[ -z "$cboxclustername" ] && {
	echo "INFO: no cluster name specified, default to testcluster"
	cboxclustername=testcluster
}

[ -z "$cboxnumnodes" ] && {
	echo "INFO: no number of nodes specified, default to 2"
	cboxnumnodes=2
}

[ -z "$cboxclustertype" ] && {
	echo "INFO: no cluster type specified, default to cman"
	cboxclustertype=cman
}

[ -z "$cboxrasmngr" ] && {
	echo "INFO: no cluster resource manager specified, default to none"
	cboxrasmngr=none
}

[ -z "$cboxfedrelease" ] && {
	if grep -q -i rawhide /etc/fedora-release; then
		cboxfedrelease=rawhide
	else
		cboxfedrelease=$(cat /etc/fedora-release | awk '{print $3}')
	fi
	echo "INFO: no fedora release define, autodetected $cboxfedrelease from host"
}

[ ! -f $cboxdatadir/fedora-$cboxfedrelease.ks ] && {
	echo "ERROR: no kickstart file for fedora $cboxfedrelease"
	exit 1
}

## cross checks
[ "$cboxclustertype" = "corosync" ] && [ "$cboxrasmngr" = "rgmanager" ] && {
	echo "ERROR: you can't select corosync and rgmanager together."
	exit 1
}

export cboxdatadir
export cboxhooksdir
export cboxclustername
export cboxnumnodes
export cboxclustertype
export cboxverbose
export cboxlogdir
export cboxlogfile
export cboxfedrelease
export cboxrasmngr

# TODO: add question here

echo "Creating cluster... this might take several minutes"
echo "check progress in $cboxlogfile"

for i in $(LC_ALL=C; echo $cboxhooksdir/*[^~,]); do
	[ -d $i ] && continue
	# skip know scripts
	[ "${i%.cfsaved}" != "${i}" ] && continue
	[ "${i%.rpmsave}" != "${i}" ] && continue
        [ "${i%.rpmorig}" != "${i}" ] && continue
        [ "${i%.rpmnew}" != "${i}" ] && continue
        [ "${i%.swp}" != "${i}" ] && continue
	[ "${i%,v}" != "${i}" ] && continue
	[ "${i%.dpkg-old}" != "${i}" ] && continue
	[ "${i%.dpkg-dist}" != "${i}" ] && continue
	[ "${i%.dpkg-new}" != "${i}" ] && continue

	if [ -x $i ]; then
		echo "starting $(basename $i)" >> $cboxlogfile
		[ -n "$cboxverbose" ] && $i >> $cboxlogfile 2>&1
		[ -z "$cboxverbose" ] && $i > /dev/null 2>&1
		echo "finished $(basename $i)" >> $cboxlogfile
	fi
done

exit 0
